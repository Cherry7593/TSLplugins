# EndDragon 模块测试指南

## 测试环境准备

### 前置条件
1. MC 服务器版本：Folia 1.21.8
2. 插件已成功加载和构建
3. 末地维度已加载
4. 至少 4 个末地水晶

## 功能测试

### 测试 1: 禁止末影龙破坏方块

**目标**：验证启用 `disable-damage` 时末影龙无法破坏方块

**步骤**：
1. 确保配置文件中 `enddragon.disable-damage: true`
2. 进入末地维度
3. 杀死末影龙或等待其生成
4. 观察末影龙行为

**预期结果**：
- ✅ 末影龙移动时不破坏任何方块
- ✅ 爆炸动画正常显示
- ✅ 主岛建筑保持完整

**失败症状**：
- ❌ 末影龙仍然破坏方块
- ❌ 方块消失或断层

### 测试 2: 禁止水晶生成

**目标**：验证启用 `disable-crystal` 时不生成新柱子和柱子水晶，但玩家可以正常放置水晶

**步骤**：
1. 确保配置文件中 `enddragon.disable-crystal: true`
2. 进入末地维度
3. **玩家手动放置测试**：
   - 在基岩传送门周围放置 4 个末地水晶
   - 检查是否可以正常放置
4. **观察复活过程**：
   - 观察龙复活动画
   - 检查是否生成新柱子

**预期结果**：
- ✅ 玩家可以正常手动放置末地水晶
- ✅ 放置 4 个水晶后龙正常复活
- ✅ 复活动画正常播放
- ✅ 不生成新的黑曜石柱子
- ✅ 不生成柱子顶部的末地水晶
- ✅ 原有的黑曜石柱子保持不变

**失败症状**：
- ❌ 玩家无法放置水晶
- ❌ 新柱子出现
- ❌ 新水晶出现在柱子顶部
- ❌ 主岛被修改

### 测试 3: 功能禁用测试

**目标**：验证禁用功能后末影龙恢复正常行为

**步骤**：
1. 修改配置文件：
   ```yaml
   enddragon:
     enabled: false
   ```
2. 执行 `/tsl reload`
3. 进入末地维度
4. 观察末影龙行为

**预期结果**：
- ✅ 末影龙恢复破坏方块
- ✅ 复活时生成水晶和柱子
- ✅ 行为恢复默认

### 测试 4: 热重载配置

**目标**：验证 `/tsl reload` 命令正确更新配置

**步骤**：
1. 记录当前配置状态
2. 修改 `config.yml` 中的 `enddragon` 配置
3. 在游戏中执行 `/tsl reload`
4. 检查新配置是否生效

**预期结果**：
- ✅ 命令执行成功
- ✅ 日志显示配置已加载
- ✅ 新配置立即生效
- ✅ 无需重启服务器

**检查方法**：
```
/tsl enddragon status
```

应显示更新后的状态。

### 测试 5: 命令系统

#### 5.1 status 命令

**步骤**：
1. 执行 `/tsl enddragon status`
2. 检查输出信息

**预期结果**：
```
═══ 末影龙控制状态 ═══
禁止破坏方块: ✓ 已禁止
禁止水晶生成: ✓ 已禁止
```

#### 5.2 on/off 命令

**步骤**：
1. 执行 `/tsl enddragon on`
2. 执行 `/tsl enddragon off`
3. 检查消息反馈

**预期结果**：
- ✅ 命令执行成功
- ✅ 显示相应提示消息

#### 5.3 Tab 补全

**步骤**：
1. 输入 `/tsl enddragon `
2. 按 TAB 键

**预期结果**：
- ✅ 显示 `on`, `off`, `status` 选项

### 测试 6: 权限检查

**目标**：验证权限系统正确工作

**步骤**：
1. 创建没有 `tsl.enddragon` 权限的玩家
2. 该玩家执行末影龙命令
3. 检查是否拒绝

**预期结果**：
- ✅ 无权限玩家收到拒绝消息
- ✅ 有权限玩家可正常执行

## 压力测试

### 测试 7: 多龙场景

**目标**：测试同时存在多个末影龙的情况

**步骤**：
1. 使用命令生成多个末影龙
2. 观察所有龙的行为
3. 监控服务器性能

**预期结果**：
- ✅ 所有龙都受到限制
- ✅ 无性能下降
- ✅ 日志正常输出

### 测试 8: 长时间运行

**目标**：验证长时间运行的稳定性

**步骤**：
1. 在末地停留 30+ 分钟
2. 观察是否有异常
3. 检查日志是否有错误

**预期结果**：
- ✅ 持续稳定工作
- ✅ 无内存泄漏
- ✅ 无错误日志

## 日志检查

### 预期日志输出

启用时：
```
[TSLplugins] [EndDragon] 配置已加载 - 启用: true, 禁止破坏: true, 禁止水晶: true
```

触发功能时：
```
[TSLplugins] [EndDragon] 阻止末影龙破坏方块
[TSLplugins] [EndDragon] 阻止末地水晶生成
```

## 边界情况测试

### 测试 9: 外岛水晶生成

**目标**：验证外岛水晶不受限制

**步骤**：
1. 前往外岛（距离主岛 > 50 格）
2. 放置末地水晶
3. 检查是否能生成

**预期结果**：
- ✅ 外岛水晶正常生成（不在禁用范围内）

### 测试 10: 边界情况

**目标**：测试禁用范围的边界

**步骤**：
1. 在 X: 50, Z: 50 放置方块
2. 让末影龙撞击
3. 检查是否被破坏

**预期结果**：
- ✅ 边界内的方块受到保护

### 测试 11: 玩家手动放置水晶

**目标**：确保玩家可以正常放置末地水晶

**步骤**：
1. 确保 `enddragon.disable-crystal: true`
2. 准备 4 个末地水晶
3. 在基岩传送门周围（Y=0 附近）放置水晶
4. 观察水晶是否成功放置
5. 检查水晶是否触发龙复活

**预期结果**：
- ✅ 玩家可以正常手动放置水晶
- ✅ 水晶放置后不会被移除
- ✅ 放置 4 个水晶后触发龙复活
- ✅ 复活过程不生成新柱子

**失败症状**：
- ❌ 水晶无法放置
- ❌ 水晶放置后立即消失
- ❌ 无法触发龙复活

## 问题排查清单

如果测试失败，检查以下项目：

- [ ] 配置文件是否正确无误
- [ ] `enddragon.enabled` 是否为 true
- [ ] 插件是否正确加载
- [ ] 是否有其他插件冲突
- [ ] 权限系统是否正确配置
- [ ] 服务器日志中是否有错误信息

## 性能基准

### 预期性能指标

| 指标 | 预期值 | 说明 |
|------|--------|------|
| 事件处理延迟 | < 1ms | 单次事件处理时间 |
| 内存占用 | < 5MB | 模块总体内存使用 |
| CPU 影响 | < 0.1% | 正常情况下的 CPU 占用 |
| 龙复活延迟 | 无感知 | 不应感受到额外延迟 |

## 完成检查清单

测试完成后，确保以下项目都已验证：

- [ ] 禁止破坏方块功能正常
- [ ] 禁止水晶生成功能正常
- [ ] 功能禁用后恢复默认行为
- [ ] 热重载配置正常工作
- [ ] 所有命令正常工作
- [ ] 权限检查正确
- [ ] 无内存泄漏
- [ ] 无异常日志
- [ ] 性能达到预期
- [ ] 边界情况正确处理

---

**测试日期**：_____________
**测试者**：_____________
**测试结果**：☐ 通过 ☐ 失败
**备注**：_________________________________________________________________

