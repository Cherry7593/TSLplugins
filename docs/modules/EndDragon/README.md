# EndDragon 末影龙控制模块

## 概述

**功能**：控制末影龙的行为，保护末地主岛建筑
**版本**：1.0
**状态**：✅ 完成

## 核心功能

### 1. 禁止末影龙破坏方块
- **监听事件**：`EntityExplodeEvent`
- **触发条件**：末影龙爆炸事件
- **实现方式**：清空爆炸方块列表
- **效果**：末影龙撞击方块时不会破坏地形

### 2. 禁止水晶和黑曜石柱子生成
- **监听事件**：
  - `PortalCreateEvent` - 拦截柱子生成事件
  - `CreatureSpawnEvent` - 拦截水晶生成（优先级更高）
  - `EntitySpawnEvent` - 备用拦截水晶生成
- **触发条件**：末影龙复活时系统自动生成
- **实现方式**：
  - 监听 `END_PLATFORM` 原因的传送门创建事件
  - 检查水晶生成高度（Y > 70，柱子顶部）
  - **直接取消事件**，阻止生成
- **效果**：末影龙复活时不会生成新的柱子和柱子顶部水晶
- **重要**：✅ 玩家仍然可以手动放置末影水晶来复活末影龙
- **优势**：✅ 不会破坏已有建筑，完全拦截生成而非事后清理

## 配置说明

```yaml
# EndDragon 末影龙控制功能配置
enddragon:
  # 是否启用末影龙控制功能
  enabled: true

  # 是否禁止末影龙破坏方块（撞方块）
  # true: 末影龙会被限制，无法破坏地形
  # false: 末影龙可以正常破坏方块
  disable-damage: true

  # 是否禁止水晶和黑曜石柱子生成
  # true: 末影龙复活时不会生成新的柱子和水晶
  # false: 末影龙复活时正常生成柱子和水晶
  disable-crystal: true
```

## 命令系统

### 基础命令
```
/tsl enddragon on      - 启用末影龙控制
/tsl enddragon off     - 禁用末影龙控制
/tsl enddragon status  - 查看当前状态
```

### 权限
- `tsl.enddragon` - 使用末影龙控制命令的基础权限

## 模块架构

### 文件结构
```
EndDragon/
├── EndDragonManager.kt     # 配置管理和状态管理
├── EndDragonCommand.kt     # 命令处理
└── EndDragonListener.kt    # 事件监听
```

### 核心类职责

#### EndDragonManager
- 加载和缓存配置
- 管理功能启用/禁用状态
- 提供状态查询方法

#### EndDragonCommand
- 处理玩家命令
- 提供帮助信息和状态显示
- Tab 补全支持

#### EndDragonListener
- 监听 `EntityExplodeEvent` - 禁止破坏方块
- 监听 `PortalCreateEvent` - 拦截柱子生成
- 监听 `CreatureSpawnEvent` - 拦截水晶生成
- 监听 `EntitySpawnEvent` - 备用水晶拦截

## 实现细节

### 禁止破坏方块的原理
1. 末影龙与方块碰撞时触发 `EntityExplodeEvent`
2. 清空事件中的 `blockList()`
3. 爆炸动画保留，但不破坏任何方块

### 禁止柱子生成的原理
1. 监听 `PortalCreateEvent` 事件
2. 检查事件原因是否为 `END_PLATFORM`（末影龙复活时的柱子生成）
3. 检查是否在末地维度
4. **直接取消事件**，完全阻止柱子和基岩生成

### 禁止水晶生成的原理
1. **区分玩家放置和系统生成**：
   - 玩家手动放置：通常在基岩层（Y ≈ 0）或现有结构上（Y < 70）
   - 系统自动生成：在柱子顶部，Y 坐标较高（Y > 70）
2. 监听 `CreatureSpawnEvent` 和 `EntitySpawnEvent`（双重保险）
3. 检查生成的实体是否为 `EnderCrystal`
4. 检查生成位置：
   - 是否在末地主岛范围内（±50 范围）
   - Y 坐标是否 > 70（柱子顶部）
5. 只取消高空生成的水��（系统自动生成的）

### 禁止柱子生成的原理
1. 监听 `BlockFormEvent`
2. 检查生成的方块是否为黑曜石
3. 检查生成位置：
   - 是否在末地主岛范围内（±50 范围）
   - Y 坐标是否 > 50（柱子高度）
4. 取消生成事件

### 主岛范围判定
```kotlin
// 末地主岛范围
val x = location.x
val z = location.z
if (x >= -50 && x <= 50 && z >= -50 && z <= 50) {
    // 在主岛范围内
}

// 柱子高度判定
if (y > 50) {  // 黑曜石柱子
    // 取消生成
}

if (y > 70) {  // 柱子顶部水晶
    // 取消生成
}
```

## 性能考虑

### 事件优先级
- `EntityExplodeEvent` - `HIGHEST` 优先级
- `EntitySpawnEvent` - `HIGHEST` 优先级

优先级较高，可以在其他插件处理前拦截。

### 性能影响
- 最小化：仅监听两个事件
- 高效检查：使用布尔值和范围判定
- 无定时任务：完全事件驱动

## 使用场景

1. **保护末地建筑**：禁止龙破坏玩家建造的建筑
2. **简化龙斗**：禁止柱子生成，让龙变得更容易应对
3. **主岛保护**：多人服务器中保护主岛完整性
4. **自定义生存**：根据游戏模式灵活配置

## 测试清单

- [ ] 启用破坏方块禁用：末影龙撞击方块不破坏
- [ ] 启用水晶禁用：复活末影龙不生成新水晶
- [ ] 禁用两个功能：末影龙恢复正常行为
- [ ] 热重载配置：/tsl reload 正确更新配置
- [ ] 命令补全：/tsl enddragon [TAB] 显示选项
- [ ] 权限检查：无权限玩家无法使用命令

## 常见问题

### Q: 禁用水晶生成后，如何复活末影龙？
A: ✅ 玩家仍然可以**正常手动放置**末地水晶（在基岩层或现有柱子上）来复活末影龙。插件只禁止系统自动生成的柱子和柱子顶部的水晶，不影响玩家手动放置。

### Q: 为什么玩家放置的水晶不会被拦截？
A: 插件通过 Y 坐标判断水晶来源：
- Y < 70：玩家手动放置（允许）
- Y > 70：系统自动生成在柱子顶部（禁止）

### Q: 玩家放置水晶后，龙会复活吗？
A: 会的！玩家手动放置 4 个末地水晶后，龙会正常复活，只是不会生成新的黑曜石柱子和柱子顶部的水晶。

### Q: 为什么外岛的龙仍然会破坏方块？
A: 外岛不在禁用范围内（默认 ±50）。如需禁用外岛，可在监听器中移除位置检查。

### Q: 破坏方块禁用后，爆炸动画还会显示吗？
A: 是的，爆炸动画会正常显示，只是方块不会被破坏。

## 扩展建议

1. **可配置范围**：在配置文件中添加可配置的主岛范围
2. **区域保护集成**：与 WorldGuard 等插件集成
3. **日志记录**：记录龙的所有破坏尝试和水晶生成事件
4. **权限豁免**：添加特殊权限允许特定玩家的龙不受限制

## 变更日志

### v1.0 (初始版本)
- ✅ 实现禁止末影龙破坏方块功能
- ✅ 实现禁止水晶生成功能
- ✅ 完整的命令系统
- ✅ 配置热重载支持

